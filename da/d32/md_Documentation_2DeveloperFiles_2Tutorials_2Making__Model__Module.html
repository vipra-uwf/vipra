<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>VIPRA Documentation: Making a Pedestrian Dynamics Model</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">VIPRA Documentation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Making a Pedestrian Dynamics Model</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md93"></a> This tutorial goes over creating a new pedestrian dynamics model and using it in a simulation.</p>
<p>We will make a dynamics model where pedestrians simply spin in circles.</p>
<p>The steps are the same for each module type with the only differences being:</p><ol type="1">
<li>Methods to Override</li>
<li>Module Type for .mm file</li>
<li>Location in modules.json file</li>
</ol>
<h1><a class="anchor" id="autotoc_md94"></a>
1. Create Files</h1>
<p>In <code>Modules/PedestrianDynamicsModel/</code>, we create a new directory <code>ExampleModel</code>.</p>
<p>In this new directory create three files:</p><ol type="1">
<li>exampleModel.hpp</li>
<li>exampleModel.cpp</li>
<li>exampleModel.mm</li>
</ol>
<p>They should all have the same name.</p>
<h1><a class="anchor" id="autotoc_md95"></a>
2. Creating The Model Class</h1>
<p>In <code>Modules/PedestrianDynamicsModel/ExampleModel/ExampleModel.hpp</code>, we create a new class <code>ExampleModel</code> that inherits from <code>VIPRA::PedestrianDynamicsModel</code>.</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="preprocessor">#ifndef VIPRA_EXAMPLE_MODEL_HPP</span></div>
<div class="line"><span class="preprocessor">#define VIPRA_EXAMPLE_MODEL_HPP</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;pedestrian_model/pedestrian_dynamics_model.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ExampleModel : <span class="keyword">public</span> <a class="code hl_class" href="../../d5/dee/classVIPRA_1_1PedestrianDynamicsModel.html">VIPRA::PedestrianDynamicsModel</a> {</div>
<div class="line"> <span class="keyword">public</span>:</div>
<div class="line">  <span class="keywordtype">void</span> configure(<span class="keyword">const</span> VIPRA::Config&amp;) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> initialize(<span class="keyword">const</span> <a class="code hl_class" href="../../d0/df4/classVIPRA_1_1PedestrianSet.html">VIPRA::PedestrianSet</a>&amp;, <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d30/classVIPRA_1_1ObstacleSet.html">VIPRA::ObstacleSet</a>&amp;,</div>
<div class="line">                  <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d4b/classVIPRA_1_1Goals.html">VIPRA::Goals</a>&amp;) <span class="keyword">override</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> timestep(<span class="keyword">const</span> <a class="code hl_class" href="../../d0/df4/classVIPRA_1_1PedestrianSet.html">VIPRA::PedestrianSet</a>&amp;, <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d30/classVIPRA_1_1ObstacleSet.html">VIPRA::ObstacleSet</a>&amp;,</div>
<div class="line">                <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d4b/classVIPRA_1_1Goals.html">VIPRA::Goals</a>&amp;, <a class="code hl_struct" href="../../d4/da2/structVIPRA_1_1State.html">VIPRA::State</a>&amp;, VIPRA::delta_t, VIPRA::t_step) <span class="keyword">override</span>;</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="aclassVIPRA_1_1Goals_html"><div class="ttname"><a href="../../d1/d4b/classVIPRA_1_1Goals.html">VIPRA::Goals</a></div><div class="ttdoc">Interface class for defining pedestrian goals in a simulation.</div><div class="ttdef"><b>Definition</b> goals.hpp:38</div></div>
<div class="ttc" id="aclassVIPRA_1_1ObstacleSet_html"><div class="ttname"><a href="../../d1/d30/classVIPRA_1_1ObstacleSet.html">VIPRA::ObstacleSet</a></div><div class="ttdoc">Interface for handling obstacles in a map.</div><div class="ttdef"><b>Definition</b> obstacle_set.hpp:36</div></div>
<div class="ttc" id="aclassVIPRA_1_1PedestrianDynamicsModel_html"><div class="ttname"><a href="../../d5/dee/classVIPRA_1_1PedestrianDynamicsModel.html">VIPRA::PedestrianDynamicsModel</a></div><div class="ttdoc">Interface for modeling pedestrian dynamics.</div><div class="ttdef"><b>Definition</b> pedestrian_dynamics_model.hpp:46</div></div>
<div class="ttc" id="aclassVIPRA_1_1PedestrianSet_html"><div class="ttname"><a href="../../d0/df4/classVIPRA_1_1PedestrianSet.html">VIPRA::PedestrianSet</a></div><div class="ttdoc">Interface for managing pedestrian information in a simulation.</div><div class="ttdef"><b>Definition</b> pedestrian_set.hpp:44</div></div>
<div class="ttc" id="astructVIPRA_1_1State_html"><div class="ttname"><a href="../../d4/da2/structVIPRA_1_1State.html">VIPRA::State</a></div><div class="ttdef"><b>Definition</b> state.hpp:13</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md96"></a>
3. Creating Module Parameters</h1>
<p>Most models will take in parameters for pedestrian mass, max speed, etc.</p>
<p>Our example model will take in two parameters:</p><ol type="1">
<li>Speed - how fast pedestrians move</li>
<li>Direction - which direction they spin in</li>
</ol>
<p>We need to add these parameters, along with other module information, to the module's <code>.mm</code> file</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;id&quot;: &quot;zoumfgHMPhEUue9juYzbd&quot;,              // A random string sufficiently random to reduce likelyhood of collisions</div>
<div class="line">  &quot;name&quot;: &quot;exampleModel&quot;,                     // Name of module files (exampleModel.hpp, exampleModel.cpp, exampleModel.mm)</div>
<div class="line">  &quot;description&quot;: &quot;An Example Pedestrian dynamics model&quot;,  // Simple description, not used right now but will be in the future</div>
<div class="line">  &quot;params&quot;: [</div>
<div class="line">    { </div>
<div class="line">      &quot;name&quot;: &quot;speed&quot;,    // Parameter name</div>
<div class="line">      &quot;type&quot;: &quot;float&quot;,    // Parameter type, currently only float or string</div>
<div class="line">      &quot;description&quot;: &quot;Speed pedestrians move&quot;  // description of use</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      &quot;name&quot;: &quot;direction&quot;,</div>
<div class="line">      &quot;type&quot;: &quot;string&quot;,</div>
<div class="line">      &quot;description&quot;: &quot;Direction of spin, right or left&quot;</div>
<div class="line">    }</div>
<div class="line">  ],</div>
<div class="line">  &quot;className&quot;: &quot;ExampleModel&quot;,          // Name of class</div>
<div class="line">  &quot;type&quot;: &quot;pedestrian_dynamics_model&quot;   // Module Type, lowercase with spaces replaced by underscores</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md97"></a>
4. Implementation</h1>
<p>Next is to code the implementation of the model.</p>
<div class="fragment"><div class="line"> ++</div>
<div class="line"><span class="preprocessor">#include &quot;exampleModel.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// configure takes in the module parameters from a file</span></div>
<div class="line"><span class="keywordtype">void</span> ExampleModel::configure(<span class="keyword">const</span> VIPRA::Config&amp; config) {</div>
<div class="line">  speed = config[<span class="stringliteral">&quot;speed&quot;</span>].get&lt;<span class="keywordtype">float</span>&gt;();</div>
<div class="line">  direction = config[<span class="stringliteral">&quot;direction&quot;</span>].get&lt;std::string&gt;() == <span class="stringliteral">&quot;right&quot;</span>;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (direction) {</div>
<div class="line">    speed *= -1;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// initialize sets up any data, stuctures, etc. needed</span></div>
<div class="line"><span class="keywordtype">void</span> ExampleModel::initialize(<span class="keyword">const</span> <a class="code hl_class" href="../../d0/df4/classVIPRA_1_1PedestrianSet.html">VIPRA::PedestrianSet</a>&amp; pedSet,</div>
<div class="line">                              <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d30/classVIPRA_1_1ObstacleSet.html">VIPRA::ObstacleSet</a>&amp;, <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d4b/classVIPRA_1_1Goals.html">VIPRA::Goals</a>&amp;) {</div>
<div class="line">  startingCoords = pedSet.getCoordinates();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// timestep is called for each timestep of the simulation, with the new positions/velocities being placed in the passed in VIPRA::State&amp;</span></div>
<div class="line"><span class="keywordtype">void</span> ExampleModel::timestep(<span class="keyword">const</span> <a class="code hl_class" href="../../d0/df4/classVIPRA_1_1PedestrianSet.html">VIPRA::PedestrianSet</a>&amp; pedSet, <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d30/classVIPRA_1_1ObstacleSet.html">VIPRA::ObstacleSet</a>&amp;,</div>
<div class="line">                            <span class="keyword">const</span> <a class="code hl_class" href="../../d1/d4b/classVIPRA_1_1Goals.html">VIPRA::Goals</a>&amp;, <a class="code hl_struct" href="../../d4/da2/structVIPRA_1_1State.html">VIPRA::State</a>&amp; state, VIPRA::delta_t dT,</div>
<div class="line">                            VIPRA::t_step currStep) {</div>
<div class="line">  <span class="keyword">const</span> VIPRA::cnt pedCnt = pedSet.getNumPedestrians();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (VIPRA::idx i = 0; i &lt; pedCnt; ++i) {</div>
<div class="line">    <span class="keyword">auto</span>&amp; start = startingCoords.at(i);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// The VIPRA::State&amp; is were our updates for the next time step are placed</span></div>
<div class="line">    state.coords[i] = start + (<a class="code hl_struct" href="../../d8/d28/structVIPRA_1_1f3d.html">VIPRA::f3d</a>{<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(std::cos(speed * currStep * dT)),</div>
<div class="line">                                          <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(std::sin(speed * currStep * dT))} *</div>
<div class="line">                               0.25F);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="astructVIPRA_1_1f3d_html"><div class="ttname"><a href="../../d8/d28/structVIPRA_1_1f3d.html">VIPRA::f3d</a></div><div class="ttdef"><b>Definition</b> dimensions.hpp:135</div></div>
</div><!-- fragment --><p>An actual model will likely use the <a class="el" href="../../d3/d85/md_Documentation_2DeveloperFiles_2Modules_2PedestrianSet.html">PedestrianSet</a>, <a class="el" href="../../d7/dbb/md_Documentation_2DeveloperFiles_2Modules_2ObstacleSet.html">ObstacleSet</a>, and <a class="el" href="../../d8/dac/md_Documentation_2DeveloperFiles_2Modules_2Goals.html">Goals</a>. For collision detection, calculating repulsive forces, finding direction of travel, etc.</p>
<p>Take a look at the other module pages to see what they can do, or see the <a class="el" href="../../d2/d72/md_Documentation_2DeveloperFiles_2Modules_2ModulesOverview.html">modules overview</a>.</p>
<h1><a class="anchor" id="autotoc_md98"></a>
5. Adding Model to modules.json</h1>
<p>We need to add our new module in <code>VIPRA/modules.json</code>, this makes it available for use in the simulation.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  ... other module types</div>
<div class="line"> </div>
<div class="line">  &quot;pedestrian_dynamics_model&quot;: [</div>
<div class="line">    {</div>
<div class="line">      &quot;id&quot;: &quot;VbGjNW5NCkOmKAxvFmz5KwUV2zz469&quot;,</div>
<div class="line">      &quot;name&quot;: &quot;calm_pedestrian_model&quot;,</div>
<div class="line">      &quot;className&quot;: &quot;CalmPedestrianModel&quot;,</div>
<div class="line">      &quot;dirPath&quot;: &quot;../Modules/PedestrianDynamicsModel/calm_pedestrian_model&quot;</div>
<div class="line">    },</div>
<div class="line">    {                                   // Add our new model under &quot;pedestrian_dynamics_model&quot;</div>
<div class="line">      &quot;id&quot;: &quot;zoumfgHMPhEUue9juYzbd&quot;,    // id from .mm file</div>
<div class="line">      &quot;name&quot;: &quot;exampleModel&quot;,           // file names</div>
<div class="line">      &quot;className&quot;: &quot;ExampleModel&quot;,      // C++ Class name</div>
<div class="line">      &quot;dirPath&quot;: &quot;../Modules/PedestrianDynamicsModel/ExampleModel&quot; // relative or absolute path to module directory (relative from VIPRA/ directory)</div>
<div class="line">    }</div>
<div class="line">  ],</div>
<div class="line"> </div>
<div class="line">  ... other module types</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md99"></a>
6. Compilation</h1>
<p>Since we added a new module the simulation needs to be recompiled.</p>
<p>In <code>VIPRA/</code> run: </p><div class="fragment"><div class="line">make release</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md100"></a>
7. Running The Simulation</h1>
<p>First we need to set the simulation to use our new model, in a new simulation configuration file.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;id&quot;: &quot;ExampleConfig&quot;,</div>
<div class="line">  &quot;name&quot;: &quot;exampleconfig&quot;,</div>
<div class="line">  &quot;description&quot;: &quot;This is the example config file&quot;,</div>
<div class="line">  &quot;seed&quot;: 2453254734347,</div>
<div class="line">  &quot;modules&quot;: {</div>
<div class="line">    &quot;output_sink&quot;: &quot;dkSDMqF7Q55UWSxva6pm&quot;,</div>
<div class="line">    &quot;pedestrian_set&quot;: &quot;jLcPe7ZP8G15AFH5vPb6Wz2DrIVT94&quot;,</div>
<div class="line">    &quot;obstacle_set&quot;: &quot;MTpemEr4jv5XTvgwO7q54Qco97Pnt4&quot;,</div>
<div class="line">    &quot;goals&quot;: &quot;Xz59g1o8HcsnMJlKaiYw00wZ19rB7P&quot;,</div>
<div class="line">    &quot;pedestrian_dynamics_model&quot;: &quot;zoumfgHMPhEUue9juYzbd&quot;, // The id of our new model module</div>
<div class="line">    &quot;map_loader&quot;: &quot;YKzTon61i8LuHr9l15mCY3&quot;,</div>
<div class="line">    &quot;pedestrian_loader&quot;: &quot;8oGawQjwJZutb4Us6lDU7R&quot;,</div>
<div class="line">    &quot;policy_model&quot;: &quot;6xc3IZPOYEcdNhPd8x1kWP&quot;,</div>
<div class="line">    &quot;configuration_reader&quot;: &quot;5E4V21CyOwU5iMBfH97qlFDn6DlAlf&quot;,</div>
<div class="line">    &quot;human_behavior_model&quot;: &quot;e3y1yG6PSjrWzsptf6jHdfBElwFugQ&quot;,</div>
<div class="line">    &quot;simulation&quot;: &quot;QQgWGHtxsVWT1jIEXbxjKG1HA3iqI0&quot;</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Next we can create a <a class="el" href="../../d0/d6b/md_Documentation_2DeveloperFiles_2Modules_2Parameters.html">module parameters</a> file and add our parameters.</p>
<div class="fragment"><div class="line">... other module parameters</div>
<div class="line"> </div>
<div class="line">  &quot;pedestrian_dynamics_model&quot;: {</div>
<div class="line">      &quot;speed&quot;: 1.0,</div>
<div class="line">      &quot;direction&quot;: &quot;right&quot;</div>
<div class="line">  },</div>
<div class="line"> </div>
<div class="line">... other module parameters</div>
</div><!-- fragment --><p><a class="el" href="../../d8/d03/md_Documentation_2ResearcherFiles_2Running.html">Run the simulation</a>, with the paths to the simulation config and parameters.</p>
<p>In my case: </p><div class="fragment"><div class="line">./VIPRA_SIM 1 ../SimConfigs/TestConfig/sim.config ../SimConfigs/TestConfig/module_params.json ../Maps/pedestrian_maps/a320_144_pedestrians/a320_144_pedestrians.pmap ../Maps/obstacle_maps/a320_144_obstacles/a320_144_obstacles.omap</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
